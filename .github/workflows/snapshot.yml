name: Snapshot

on:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write

jobs:
  snapshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit short SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Delete existing dev release
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const tag = 'dev';
            
            try {
              // Get the release ID
              const release = await github.rest.repos.getReleaseByTag({
                owner,
                repo,
                tag
              });
              
              // Delete the release
              await github.rest.repos.deleteRelease({
                owner,
                repo,
                release_id: release.data.id
              });
              
              console.log(`Deleted existing dev release`);
            } catch (error) {
              if (error.status === 404) {
                console.log(`No existing dev release found`);
              } else {
                console.log(`Error deleting release: ${error.message}`);
              }
            }
            
            try {
              // Delete the tag
              await github.rest.git.deleteRef({
                owner,
                repo,
                ref: `tags/${tag}`
              });
              
              console.log(`Deleted existing dev tag`);
            } catch (error) {
              if (error.status === 404 || error.status === 422) {
                console.log(`No existing dev tag found`);
              } else {
                console.log(`Error deleting tag: ${error.message}`);
              }
            }

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Run GoReleaser Snapshot
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --snapshot --clean --config .goreleaser.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create dev release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: dev
          name: Development Build
          body: |
            ## üöÄ Development Build
            
            This is an automated development build from the main branch.
            
            **Commit**: ${{ steps.sha.outputs.short }}
            **Branch**: main
            
            ### ‚ö†Ô∏è Warning
            This is a development snapshot and may contain unstable changes.
            Use at your own risk.
            
            ### üì¶ Installation
            Download the appropriate binary for your system from the assets below.
          files: |
            dist/ucloud-upload-image-*
            dist/checksums.txt
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}